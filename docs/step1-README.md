1단계-엔티티 매핑
===
# 미션 설명
### 요구사항
> QnA 서비스를 만들어가면서 JPA로 실제 도메인 모델을 어떻게 구성하고, 객체와 테이블을 어떻게 매핑해야 하는지 알아본다.
- 아래의 DDL(Data Definition Language)을 보고 유추하여 엔티티 클래스와 레포지토리 클래스를 작성해 본다.
- `@DataJpaTest`를 사용하여 학습 테스트를 해 본다.
```sql
create table user
(
    id         bigint generated by default as identity,
    created_at timestamp   not null,
    email      varchar(50),
    name       varchar(20) not null,
    password   varchar(20) not null,
    updated_at timestamp,
    user_id    varchar(20) not null,
    primary key (id)
)

alter table user
    add constraint UK_a3imlf41l37utmxiquukk8ajc unique (user_id)
```
```sql
create table question
(
    id         bigint generated by default as identity,
    contents   clob,
    created_at timestamp    not null,
    deleted    boolean      not null,
    title      varchar(100) not null,
    updated_at timestamp,
    writer_id  bigint,
    primary key (id)
)
```
```sql
create table answer
(
    id          bigint generated by default as identity,
    contents    clob,
    created_at  timestamp not null,
    deleted     boolean   not null,
    question_id bigint,
    updated_at  timestamp,
    writer_id   bigint,
    primary key (id)
)
```
```sql
create table delete_history
(
    id            bigint generated by default as identity,
    content_id    bigint,
    content_type  varchar(255),
    create_date   timestamp,
    deleted_by_id bigint,
    primary key (id)
)
```

### 힌트
- Spring Data JPA 사용 시 아래 옵션은 동작 쿼리를 로그로 확인할 수 있게 해준다.
```properties
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.show-sql=true
```
- H2 데이터베이스 사용 시, 아래의 프로퍼티를 추가하면 MySQL Dialect를 사용할 수 있다.
```properties
spring.datasource.url=jdbc:h2:~/test;MODE=MySQL
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL57Dialect
```

---
# 미션 진행
### 구현 목표
- QnA 서비스를 만들기 위해 주어진 DDL을 참고하여 JPA 도메인 모델 설계 및 객체와 테이블을 매핑한다.
- QnA 서비스 개발에 필요한 구현 기능 목록을 작성하고 구현한다.

### 구현 기능 목록 : TODO List
- Entity 매핑
- [x] 회원 Entity 설계
  - 식별자(id) : bigint generated by default as identity
  - 아이디(user_id) : varchar(20) not null, unique
  - 비밀번호(password) : varchar(20) not null
  - 이름(name) : varchar(20) not null
  - 이메일(email) : varchar(50)
  - 생성일시(created_at) : timestamp not null
  - 수정일시(updated_at) : timestamp
    
- [x] 질문 Entity 설계
  - 식별자(id) : bigint generated by default as identity
  - 제목(title) : varchar(100) not null
  - 내용(contents) : clob
  - 작성자 번호(writer_id) : bigint
  - 삭제 여부(deleted) : boolean not null
  - 생성일시(created_at) : timestamp not null
  - 수정일시(updated_at) : timestamp
    
- [x] 답변 Entity 설계
  - 식별자(id) : bigint generated by default as identity
  - 작성자 번호(writer_id) : bigint
  - 질문 번호(question_id) : bigint
  - 내용(contents) : clob
  - 삭제 여부(deleted) : boolean not null
  - 생성일시(created_at) : timestamp not null
  - 수정일시(updated_at) : timestamp
    
- [x] 삭제 이력 Entity 설계
  - 식별자(id) : bigint generated by default as identity
  - 삭제 대상 번호(content_id) : bigint
  - 삭제 대상 타입(content_type) : varchar(255)
  - 삭제 사용자 번호(deleted_by_id) : bigint
  - 생성일시(create_date) : timestamp not null
  
---
- 회원 Repository TC 작성
  - [x] 회원 Entity 저장
  - [x] 회원 번호를 이용한 특정 회원 조회
  - [x] 회원 아이디를 이용한 특정 회원 조회
  - [x] 변경 감지에 의한 회원 정보 수정
    
- 질문 Repository TC 작성
  - [x] 질문 Entity 저장
    - [x] (예외) 질문 작성자 정보가 없는 질문 저장
    - [x] (예외) 질문 작성자 정보가 영속 상태가 아닌 질문 저장
  - [x] 질문 번호를 이용한 특정 질문 조회
  - [x] 삭제 상태가 아닌 특정 질문 조회
  - [x] 삭제 상태가 아닌 질문 목록 조회
  - [x] 변경 감지에 의한 질문 삭제 여부 수정
    
- 답변 Repository TC 작성
  - [x] 답변 Entity 저장
    - [x] (예외) 답변 작성자 정보가 영속상태가 아닌 답변 저장
    - [x] (예외) 질문 정보가 영속상태가 아닌 답변 저장 
  - [x] 삭제되지 않은 특정 질문의 답변 목록 조회
  - [x] 삭제 상태가 아닌 특정 답변 조회
  - [x] 변경 감지에 의한 답변 삭제 여부 수정
  - [x] 삭제된 질문에 답변 하는 경우, 고아 객체 발생
  - [x] 답변이 있는 질문 삭제 상태 변경 시, 고아 객체 발생
    
- 삭제 이력 Repository TC 작성
  - [x] 질문 삭제 이력 저장
  - [x] 답변 삭제 이력 저장

---
### 구현시 주안점
- JPA의 여러 어노테이션을 이용하여 객체와 테이블을 매핑
  - DB 중심으로 객체를 설계 했을때 발생하는 문제점
    - 객체간 참조가 어려운 구조, 외래키에 해당하는 연관 객체를 다시 조회
    
### JAP 엔티티 설계
1. @Id, @GeneratedValue, @Column 등의 Annotation을 활용한 객체 필드와 데이터베이스 컬럼 매핑
2. JPA의 show-sql 옵션 적용을 통해 설계한 JPA Entity를 기반으로 생성된 DDL 확인 
3. 설계한 Entity의 객체 생성 TC 작성
   - auto increment 속성에 의해 DB에서 할당되는 id 항목의 Null 여부 확인
   - boolean 타입 항목의 기본값 적용 여부 확인
   - Enum Type의 저장 방식이 순서 저장 방식인 `ORDINAL` 설정이 아닌 값 저장 방식인 `STRING` 적용 여부 확인

---
### 학습 키워드
- JPA Annotation을 이용한 Entity Mapping
  - 필드와 컬럼 매핑
  - 객체간 연관관계 매핑
    - 양방향 연관관계에서의 외래키 관리 주체 설정
  - Meta성 컬럼의 매핑 정보 상속
- JPA Persistence Context
  - 동일 트랜잭션 내 객체 동일성 보장
  - 변경 감지
  - 지연로딩과(Proxy) 즉시로딩
  - 쓰기 지연 저장소

---
### 코드리뷰 피드백 적용
- [x] Docs 내 잘못 표현된 오타 수정
- [x] JPA Auditing을 이용한 Entity의 공통 속성 추출 및 매핑 정보 상속
  - 생성일시(created_at) : timestamp not null
  - 수정일시(updated_at) : timestamp
- Entity Class의 equals and hashcode 적용
- git에 이미 관리되고 있는 이력용 javadoc 주석 제거
- 명확하지 않은 객체 생성 TC 수정
- 연관관계를 가지는 객체가 영속상태가 아닌 경우 검증 부 수정
